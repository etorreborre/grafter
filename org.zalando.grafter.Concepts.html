<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Main concepts</title>
    <link href="./images/s2.ico"                                   type="image/x-icon" rel="specs2 icon"/>
    <link href="./css/opensans-fonts.css"                          type="text/css"     rel="stylesheet" />
    <link href="./css/bootstrap.min.css"                           type="text/css"     rel="stylesheet" />
    <link href="./css/font-awesome.min.css"                        type="text/css"     rel="stylesheet" />
    <link href="./css/prettify.css"                                type="text/css"     rel="stylesheet" />
    <link href="./css/tabber.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/tipuesearch.css"                             type="text/css"     rel="stylesheet" />
    <link href="./css/specs2.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/specs2-user.css"                             type="text/css"     rel="stylesheet" />

    <script src="./javascript/jquery.js"                           type="text/javascript"></script>
    <script src="./javascript/jquery.jstree.js"                    type="text/javascript"></script>
    <script src="./javascript/tabber.js"                           type="text/javascript"></script>
    <script src="./javascript/tabber_start.js"                     type="text/javascript"></script>
    <script src="./javascript/prettify.js"                         type="text/javascript"></script>
    <script src="./javascript/specs2.js"                           type="text/javascript"></script>
    <script src="./javascript/specs2-user.js"                      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_set.js"      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_contents.js" type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch.min.js"      type="text/javascript"></script>

</head>
<body onload="prettyPrint(); tabberAutomatic([])">

<div class="container">

<div class="col-md-2 col-sm-3 col-xs-3 sidebar-outer">
<div class="col-md-2 fixed">

<!-- search box -->
<div class="search-box">
  <form action="search.html">
    <input type="text" name="q" id="tipue_search_input" autocomplete="off" required>
  </form>
</div>

<!-- table of contents -->
<div id="tree"><ul>
                <li id="index"><a href="index.html" title="Welcome to Grafter!">Welcome to Graf...</a>
      <ul></ul>
      <ul>
                    <ul>
                <li id="org-zalando-grafter-quickstart"><a href="org.zalando.grafter.QuickStart.html" title="Quick Start">Quick Start</a>
      <ul><ul><li><a href="org.zalando.grafter.QuickStart.html#installation" title="Installation">Installation</a>
          
        </li><li><a href="org.zalando.grafter.QuickStart.html#your-first-application" title="Your first application">Your first appl...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-createsingletons"><a href="org.zalando.grafter.CreateSingletons.html" title="Singletons">Singletons</a>
      <ul><ul><li><a href="org.zalando.grafter.CreateSingletons.html#make-singletons" title="Make singletons">Make singletons</a>
          
        </li><li><a href="org.zalando.grafter.CreateSingletons.html#make-singletons-based-on-values" title="Make singletons based on values">Make singletons...</a>
          <ul><li><a href="org.zalando.grafter.CreateSingletons.html#modify-components" title="Modify components">Modify components</a>
          
        </li><li><a href="org.zalando.grafter.CreateSingletons.html#make-the-singletons" title="Make the singletons">Make the single...</a>
          
        </li></ul>
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-startapplication"><a href="org.zalando.grafter.StartApplication.html" title="Start the application">Start the appli...</a>
      <ul><ul><li><a href="org.zalando.grafter.StartApplication.html#stop-the-application" title="Stop the application">Stop the applic...</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-testapplication"><a href="org.zalando.grafter.TestApplication.html" title="Test the application">Test the applic...</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-testconfiguration"><a href="org.zalando.grafter.TestConfiguration.html" title="Test the configuration">Test the config...</a>
      <ul><ul><li><a href="org.zalando.grafter.TestConfiguration.html#collecting-ancestors" title="Collecting ancestors">Collecting ance...</a>
          
        </li><li><a href="org.zalando.grafter.TestConfiguration.html#visual-inspection" title="Visual inspection">Visual inspection</a>
          <ul><li><a href="org.zalando.grafter.TestConfiguration.html#configuration" title="Configuration">Configuration</a>
          
        </li></ul>
        </li><li><a href="org.zalando.grafter.TestConfiguration.html#with-specs2" title="With specs2">With specs2</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-concepts"><a href="org.zalando.grafter.Concepts.html" title="Main concepts">Main concepts</a>
      <ul><ul><li><a href="org.zalando.grafter.Concepts.html#readers-all-the-way-down" title="Readers all the way down">Readers all the...</a>
          
        </li><li><a href="org.zalando.grafter.Concepts.html#deal-with-interfaces" title="Deal with interfaces">Deal with inter...</a>
          
        </li><li><a href="org.zalando.grafter.Concepts.html#warning" title="Warning">Warning</a>
          
        </li><li><a href="org.zalando.grafter.Concepts.html#summary" title="Summary">Summary</a>
          
        </li></ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul><ul>
                <li id="org-zalando-grafter-comparisons"><a href="org.zalando.grafter.Comparisons.html" title="Comparisons">Comparisons</a>
      <ul></ul>
      <ul>
                    
                  </ul>
    </li>
              </ul>
                  </ul>
    </li>
              </ul></div><script>$(function () { $('#tree').jstree({'core':{'initially_open':['index','org-zalando-grafter-concepts'], 'animation':200}, 'themes' : {'theme': 'default','url': './css/themes/default/style.css'}, 'plugins':['themes', 'html_data']}); });</script>

</div>
</div>


<div class="col-md-10 col-sm-9 col-xs-9">
<h1>Main concepts</h1>
<div id="tipue_search_content"></div>

<h3 id="readers-all-the-way-down">Readers all the way down</h3>
<p>An application such as the one shown in <link class="ok"> <a href="org.zalando.grafter.QuickStart.html" tooltip="" class="ok">QuickStart</a></link> is merely a case class having its dependencies modeled as attributes.</p>
<p>Similarly the application configuration is a case class containing every piece of information needed to build the <code class="prettyprint">Application</code>. How do we connect the 2?</p>
<p>This is the purpose of the <code class="prettyprint">@reader</code> annotation on <code class="prettyprint">Application</code>. The <code class="prettyprint">@reader</code> annotation generates a <code class="prettyprint">reader</code> method in the companion object of <code class="prettyprint">Application</code>:</p>
<pre><code class="prettyprint">import cats.data.Reader

object Application {

  implicit def reader[A](implicit r1: Reader[A, HttpServer], r2: Reader[A, Database]): Reader[A, Application] =
    Reader(a =&gt; Application(r1(a), r2(a)))

}</code></pre>
<p>The declaration above states that:</p>
<ul>
<li>if there is a implicit <code class="prettyprint">Reader</code> instance to create an <code class="prettyprint">HttpServer</code> from any object of type <code class="prettyprint">A</code></li>
<li>if there is a implicit <code class="prettyprint">Reader</code> instance to create a <code class="prettyprint">Database</code> from any object of type <code class="prettyprint">A</code></li>
<li><em>then</em> there is an implicit <code class="prettyprint">Reader</code> instance to create an <code class="prettyprint">Application</code> from any object of type <code class="prettyprint">A</code>
<p/></li>
</ul>
<p>This means that we can instantiate the <code class="prettyprint">Application</code> from an <code class="prettyprint">ApplicationConfig</code>, provided that we get a way to instantiate an <code class="prettyprint">HttpServer</code> and a <code class="prettyprint">Database</code> from an <code class="prettyprint">ApplicationConfig</code>. The <code class="prettyprint">@reader</code> annotation on <code class="prettyprint">HttpServer</code> gives us:</p>
<pre><code class="prettyprint">import cats.data.Reader

object HttpServer {

  implicit def reader[A](implicit r1: Reader[A, HttpConfig]): Reader[A, HttpServer] =
    Reader(a =&gt; HttpServer(r1(a)))

}</code></pre>
<p>How can we build an <code class="prettyprint">HttpConfig</code> from the <code class="prettyprint">ApplicationConfig</code>? This is the purpose of the <code class="prettyprint">@readers</code> annotation on <code class="prettyprint">ApplicationConfig</code>. This will generate concrete readers for each member of <code class="prettyprint">ApplicationConfig</code>:</p>
<pre><code class="prettyprint">object ApplicationConfig {

  implicit def httpConfigReader: Reader[ApplicationConfig, HttpConfig] =
    Reader(_.httpConfig)

  implicit def dbConfigReader: Reader[ApplicationConfig, DbConfig] =
    Reader(_.dbConfig)
}</code></pre>
<p>From there the magic of implicit resolution will give us a valid <code class="prettyprint">Application.reader[ApplicationConfig]</code>. Well, almost. You might have noticed that <code class="prettyprint">Database</code> is an interface, not a case class. How can we instantiate such an interface from the application configuration?</p>
<h3 id="deal-with-interfaces">Deal with interfaces</h3>
<p>For interfaces we need a special annotation which will specify a concrete implementation to instantiate, the <code class="prettyprint">@defaultReader</code> annotation. It generates the following reader:</p>
<pre><code class="prettyprint">object Database {
  implicit def reader[A]: Reader[A, PostgresDatabase] =
    PostgresDatabase.reader[A]
}</code></pre>
<p>This <code class="prettyprint">Reader</code> instance is simply delegating to the <code class="prettyprint">Reader</code> instance of <code class="prettyprint">PostgresDatabase</code> and we now know that we have such an instance because there is a <code class="prettyprint">@reader</code> annotation on <code class="prettyprint">PostgresDatabase</code>.</p>
<h3 id="warning">Warning</h3>
<p><img src="images/icon_failure_sml.gif" alt="warning" /> ** All the components must be totally side-effects free when instantiated! ** They must not start a database connection or a http server or even do some logging!</p>
<p>Indeed, when using <code class="prettyprint">Readers</code> to create components, the same <code class="prettyprint">Database</code> component can be instantiated from different paths in the application graph and become “duplicated” at that stage (see <link class="ok"> <a href="org.zalando.grafter.CreateSingletons.html" tooltip="" class="ok">create singletons</a></link> to fix this). So it is particularly important that the “start” of an application is done in a very controlled way: <link class="ok"> <a href="org.zalando.grafter.StartApplication.html" tooltip="" class="ok">start the application</a></link>.</p>
<h3 id="summary">Summary</h3>
<p>In summary, to wire an application with Grafter you need to annotate:</p>
<ul>
<li>components with <code class="prettyprint">@reader</code></li>
<li>interfaces with <code class="prettyprint">@defaultReader</code></li>
<li>the configuration with <code class="prettyprint">@readers</code>
<p/></li>
</ul>
<p>There are a few more things you might need to know:</p>
<ul>
<li>how to <link class="ok"> <a href="org.zalando.grafter.CreateSingletons.html" tooltip="" class="ok">create singletons</a></link>?</li>
<li>how to <link class="ok"> <a href="org.zalando.grafter.StartApplication.html" tooltip="" class="ok">start the application</a></link>?</li>
<li>how to <link class="ok"> <a href="org.zalando.grafter.TestApplication.html" tooltip="" class="ok">test the application</a></link>?</li>
</ul>
</div>

<script>
$(document).ready(function() {
  $('#tipue_search_input').tipuesearch({
    'show': 6
  });
});
</script>
</div>

</body>
</html>