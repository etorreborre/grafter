<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Typesafe configurations</title>
    <link href="./images/s2.ico"                                   type="image/x-icon" rel="specs2 icon"/>
    <link href="./css/opensans-fonts.css"                          type="text/css"     rel="stylesheet" />
    <link href="./css/bootstrap.min.css"                           type="text/css"     rel="stylesheet" />
    <link href="./css/font-awesome.min.css"                        type="text/css"     rel="stylesheet" />
    <link href="./css/prettify.css"                                type="text/css"     rel="stylesheet" />
    <link href="./css/tabber.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/tipuesearch.css"                             type="text/css"     rel="stylesheet" />
    <link href="./css/specs2.css"                                  type="text/css"     rel="stylesheet" />
    <link href="./css/specs2-user.css"                             type="text/css"     rel="stylesheet" />

    <script src="./javascript/jquery.js"                           type="text/javascript"></script>
    <script src="./javascript/jquery.jstree.js"                    type="text/javascript"></script>
    <script src="./javascript/tabber.js"                           type="text/javascript"></script>
    <script src="./javascript/tabber_start.js"                     type="text/javascript"></script>
    <script src="./javascript/prettify.js"                         type="text/javascript"></script>
    <script src="./javascript/specs2.js"                           type="text/javascript"></script>
    <script src="./javascript/specs2-user.js"                      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_set.js"      type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch_contents.js" type="text/javascript"></script>
    <script src="./javascript/tipuesearch/tipuesearch.min.js"      type="text/javascript"></script>

</head>
<body onload="prettyPrint(); tabberAutomatic([])">

<div class="container">

<div class="col-md-1"></div>

<div class="col-md-1"></div>




<div class="col-md-10 col-sm-9 col-xs-9">
<h1>Typesafe configurations</h1>
<div id="tipue_search_content"></div>

<p>In some projects there can be several configurations for different “environments”, say for “Production” and “Development”. For example:</p>
<pre><code class="prettyprint">@readers
case class Config(
  threadsNb:      Int,
  defaultTimeout: FiniteDuration,
  paymentsUri:    Uri,
  ordersUri:      Uri)

val productionConfig: Config =
  Config(
    threadsNb = 8,
    defaultTimeout = 3.seconds,
    paymentsUri = Uri(&quot;http://acme.org/payments&quot;),
    ordersUri   = Uri(&quot;http://acme.org/orders&quot;))

val developmentConfig: Config =
  Config(
    threadsNb = 8,
    defaultTimeout = 3.seconds,
    paymentsUri = Uri(&quot;http://acme-test.org/payments&quot;),
    ordersUri   = Uri(&quot;http://acme-test.org/orders&quot;))</code></pre>
<p>Since <code class="prettyprint">Config</code> is just a case class which can have lots of fields it can be very tempting to derive the development config from the production config:</p>
<pre><code class="prettyprint">val productionConfig: Config =
  Config(
    threadsNb = 8,
    defaultTimeout = 3.seconds,
    paymentsUri = Uri(&quot;http://acme.org/payments&quot;),
    ordersUri   = Uri(&quot;http://acme.org/orders&quot;))

val developmentConfig: Config =
  productionConfig.copy(
    paymentsUri = Uri(&quot;http://acme-test.org/payments&quot;),
    ordersUri   = Uri(&quot;http://acme-test.org/orders&quot;)
  )</code></pre>
<p>The good thing here is that we are removing some duplication in our declarations because <code class="prettyprint">developmentConfig</code> sort of inherits from <code class="prettyprint">productionConfig</code>. This is slightly dangerous though because if you forget to override one of the production fields, like <code class="prettyprint">paymentsUri</code> you might accidentally run some code against production while executing your tests!</p>
<p>The opposite situation, where you define <code class="prettyprint">productionConfig</code> in terms of <code class="prettyprint">developmentConfig</code> is not enviable either because you might run your production application against tests services and some data might be simply lost.</p>
<h3 id="making-it-typesafe">Making it typesafe</h3>
<p>It is possible to make the configuration typesafe with one simple type parameter:</p>
<pre><code class="prettyprint">trait Prod
object Prod extends Prod

trait Dev
object Dev extends Dev

type -&gt;[A, B] = (A, B)

@readers
case class Config[C](
  threadsNb:      Int,
  defaultTimeout: FiniteDuration,
  paymentsUri:    Uri -&gt; C,
  ordersUri:      Uri -&gt; C)

val prodPaymentsUri: Uri -&gt; Prod =
  Uri(&quot;http://acme.org/payments&quot;) -&gt; Prod

val prodOrdersUri: Uri -&gt; Prod =
  Uri(&quot;http://acme-test.org/orders&quot;) -&gt; Prod

val devPaymentsUri: Uri -&gt; Dev =
  Uri(&quot;http://acme-test.org/payments&quot;) -&gt; Dev

val devOrdersUri: Uri -&gt; Dev =
  Uri(&quot;http://acme-test.org/orders&quot;) -&gt; Dev

val productionConfig: Config[Prod] =
  Config(
    threadsNb = 8,
    defaultTimeout = 3.seconds,
    paymentsUri = prodPaymentsUri,
    ordersUri   = prodOrdersUri)

val developmentConfig: Config[Dev] =
  productionConfig.copy(
    paymentsUri = devPaymentsUri,
    ordersUri   = devOrdersUri
  )

// Now it is a lot harder to mix-up configurations
// The following 2 tentatives of mixing-up production and development
// configurations do not compile
/*

val accidentalProdOverride: Config[Prod] =
  productionConfig.copy(paymentsUri = devPaymentsUri)

val accidentalDevOverride: Config[Dev] =
  developmentConfig.copy(paymentsUri = prodPaymentsUri)
*/

// But this compiles ok
val sandboxPaymentsUri: Uri -&gt; Dev =
  Uri(&quot;http://acme-sandbox.org/payments&quot;) -&gt; Dev

val okDevOverride: Config[Dev] =
  developmentConfig.copy(paymentsUri = sandboxPaymentsUri)</code></pre>
<h3 id="readers">Readers</h3>
<p>What about the <code class="prettyprint">@readers</code> annotation? What does it generate for fields annotated with <code class="prettyprint">Prod</code> or <code class="prettyprint">Dev</code>?</p>
<p>The <code class="prettyprint">readers</code> annotation is smart enough to recognize those fields and create a <code class="prettyprint">Reader</code> instance stripping out the environment annotation, for example:</p>
<pre><code class="prettyprint">implicit def paymentsUriReader[A1]: Reader[Config[A1], Uri] =
  Reader(_.paymentsUri._1)</code></pre>
</div>

</div>

</body>
</html>